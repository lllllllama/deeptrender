name: Update Keywords

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      source:
        description: 'æ•°æ®æº (arxiv/openalex/s2/openreview/all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arxiv
          - openalex
          - s2
          - openreview
      venues:
        description: 'è¦æ›´æ–°çš„ä¼šè®®ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ ICLR,NeurIPSï¼‰'
        required: false
        default: ''
      years:
        description: 'è¦æ›´æ–°çš„å¹´ä»½ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ 2024,2023ï¼‰'
        required: false
        default: ''
      limit:
        description: 'æ¯é˜¶æ®µå¤„ç†ä¸Šé™ï¼ˆæµ‹è¯•ç”¨ï¼‰'
        required: false
        default: ''
      arxiv_days:
        description: 'arXiv é‡‡é›†å¤©æ•°'
        required: false
        default: '7'
      ccf_tier:
        description: 'CCF ç­‰çº§è¿‡æ»¤ (A/B/C/all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - A
          - B
          - C
      export_only:
        description: 'ä»…å¯¼å‡ºé™æ€ç«™ç‚¹ï¼ˆè·³è¿‡æ•°æ®é‡‡é›†ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Cache sentence-transformers models
        uses: actions/cache@v4
        with:
          path: ~/.cache/torch/sentence_transformers
          key: ${{ runner.os }}-sentence-transformers-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-sentence-transformers-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        timeout-minutes: 10
      
      - name: Create required directories
        run: |
          mkdir -p data output/figures output/reports
          touch data/.gitkeep output/figures/.gitkeep output/reports/.gitkeep
      
      - name: Verify environment
        run: |
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          echo "Working directory: $(pwd)"
          echo "Directory structure:"
          ls -la
          echo "Data directory:"
          ls -la data/ || echo "data/ not found"
          pip list | grep -E "(openreview|yake|keybert|sentence-transformers|flask)" || echo "Some packages not found"
      
      - name: Run update pipeline
        if: ${{ github.event.inputs.export_only != 'true' }}
        env:
          OPENREVIEW_USERNAME: ${{ secrets.OPENREVIEW_USERNAME }}
          OPENREVIEW_PASSWORD: ${{ secrets.OPENREVIEW_PASSWORD }}
          PYTHONUNBUFFERED: "1"
        timeout-minutes: 45
        run: |
          set -e
          
          CMD="python src/main.py"
          
          SOURCE="${{ github.event.inputs.source }}"
          if [ -z "$SOURCE" ]; then
            SOURCE="all"
          fi
          CMD="$CMD --source $SOURCE"
          
          ARXIV_DAYS="${{ github.event.inputs.arxiv_days }}"
          if [ -n "$ARXIV_DAYS" ]; then
            CMD="$CMD --arxiv-days $ARXIV_DAYS"
          fi
          
          if [ -n "${{ github.event.inputs.venues }}" ]; then
            VENUES=$(echo "${{ github.event.inputs.venues }}" | tr ',' ' ')
            CMD="$CMD --venue $VENUES"
          fi
          
          if [ -n "${{ github.event.inputs.years }}" ]; then
            YEARS=$(echo "${{ github.event.inputs.years }}" | tr ',' ' ')
            CMD="$CMD --year $YEARS"
          fi
          
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            CMD="$CMD --limit ${{ github.event.inputs.limit }}"
          fi
          
          echo "========================================="
          echo "Running: $CMD"
          echo "========================================="
          
          $CMD || {
            echo "Pipeline failed with exit code $?"
            exit 1
          }
          
          echo "========================================="
          echo "Pipeline completed successfully"
          echo "========================================="
      
      - name: Export static site
        timeout-minutes: 10
        run: |
          set -e
          
          echo "========================================="
          echo "Exporting static site to docs/"
          echo "========================================="
          
          python src/tools/export_static_site.py --output-dir docs --top-keywords 300 || {
            echo "âŒ Static site export failed with exit code $?"
            exit 1
          }
          
          echo "========================================="
          echo "Static site export completed"
          echo "========================================="
          
          if [ -d "docs" ]; then
            echo "ðŸ“ docs/ directory contents:"
            ls -lah docs/
            echo ""
            echo "ðŸ“Š docs/data/ structure:"
            find docs/data -type f -name "*.json" | head -20
          fi
      
      - name: Generate summary
        if: always()
        run: |
          echo "========================================="
          echo "Pipeline Summary"
          echo "========================================="
          
          if [ -f "data/keywords.db" ]; then
            DB_SIZE=$(du -h data/keywords.db | cut -f1)
            echo "Database size: $DB_SIZE"
            
            PAPER_COUNT=$(python -c "
            import sys
            sys.path.insert(0, 'src')
            try:
                from database import get_repository
                repo = get_repository()
                print(repo.get_paper_count())
            except Exception as e:
                print('Error:', e)
            " 2>/dev/null || echo "N/A")
            
            echo "Total papers: $PAPER_COUNT"
          else
            echo "Database not found"
          fi
          
          if [ -d "output/figures" ]; then
            FIGURE_COUNT=$(find output/figures -type f -name "*.png" 2>/dev/null | wc -l)
            echo "Generated figures: $FIGURE_COUNT"
          fi
          
          if [ -d "output/reports" ]; then
            REPORT_COUNT=$(find output/reports -type f -name "*.md" 2>/dev/null | wc -l)
            echo "Generated reports: $REPORT_COUNT"
          fi
          
          echo "========================================="
      
      - name: Commit and push changes
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add data/ output/ docs/ -f
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi
          
          DATE=$(date +%Y-%m-%d)
          PAPER_COUNT=$(python -c "
          import sys
          sys.path.insert(0, 'src')
          try:
              from database import get_repository
              print(get_repository().get_paper_count())
          except:
              print('N/A')
          " 2>/dev/null || echo "A")
          
          git commit -m "chore: auto-update keywords [$DATE]" \
                     -m "ðŸ“Š Total papers: $PAPER_COUNT" \
                     -m "ðŸ¤– Automated by GitHub Actions"
          
          git push || {
            echo "âŒ Failed to push changes"
            exit 1
          }
          
          echo "âœ… Changes committed and pushed successfully"
      
      - name: Notify deployed server (optional)
        if: success() && vars.DEPLOY_URL != ''
        continue-on-error: true
        run: |
          echo "Notifying deployed server..."
          curl -X POST "${{ vars.DEPLOY_URL }}/api/refresh" \
            --connect-timeout 10 \
            --max-time 30 \
            -H "Content-Type: application/json" \
            -d '{"source": "github-actions", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' || {
            echo "âš ï¸ Failed to notify server (non-critical)"
          }
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deeptrender-data-${{ github.run_number }}
          path: |
            data/keywords.db
            output/reports/
            output/figures/
            docs/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸ”¬ DeepTrender Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/keywords.db" ]; then
            DB_SIZE=$(du -h data/keywords.db | cut -f1)
            echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- Database size: \`$DB_SIZE\`" >> $GITHUB_STEP_SUMMARY
            
            PAPER_COUNT=$(python -c "
            import sys
            sys.path.insert(0, 'src')
            try:
                from database import get_repository
                print(get_repository().get_paper_count())
            except:
                print('N/A')
            " 2>/dev/null || echo "N/A")
            echo "- Total papers: \`$PAPER_COUNT\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "output/figures" ]; then
            FIGURE_COUNT=$(find output/figures -type f -name "*.png" 2>/dev/null | wc -l)
            echo "- Generated figures: \`$FIGURE_COUNT\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "output/reports" ]; then
            REPORT_COUNT=$(find output/reports -type f -name "*.md" 2>/dev/null | wc -l)
            echo "- Generated reports: \`$REPORT_COUNT\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Status" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "Pipeline completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "Pipeline encountered issues. Check logs for details. âš ï¸" >> $GITHUB_STEP_SUMMARY
          fi
