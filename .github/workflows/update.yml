name: Update Keywords

on:
  schedule:
    # æ¯å¤© UTC 0:00ï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      source:
        description: 'æ•°æ®æº (arxiv/openalex/s2/openreview/all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arxiv
          - openalex
          - s2
          - openreview
      venues:
        description: 'è¦æ›´æ–°çš„ä¼šè®®ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ ICLR,NeurIPSï¼‰'
        required: false
        default: ''
      years:
        description: 'è¦æ›´æ–°çš„å¹´ä»½ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ 2024,2023ï¼‰'
        required: false
        default: ''
      limit:
        description: 'æ¯é˜¶æ®µå¤„ç†ä¸Šé™ï¼ˆæµ‹è¯•ç”¨ï¼‰'
        required: false
        default: ''
      arxiv_days:
        description: 'arXiv é‡‡é›†å¤©æ•°'
        required: false
        default: '7'

jobs:
  update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run update pipeline
        env:
          OPENREVIEW_USERNAME: ${{ secrets.OPENREVIEW_USERNAME }}
          OPENREVIEW_PASSWORD: ${{ secrets.OPENREVIEW_PASSWORD }}
        run: |
          # æ„å»ºå‘½ä»¤å‚æ•°ï¼ˆä¸‰é˜¶æ®µå·¥ä½œæµï¼‰
          CMD="python src/main.py"
          
          # æ•°æ®æº
          SOURCE="${{ github.event.inputs.source }}"
          if [ -z "$SOURCE" ]; then
            SOURCE="all"
          fi
          CMD="$CMD --source $SOURCE"
          
          # arXiv å¤©æ•°
          ARXIV_DAYS="${{ github.event.inputs.arxiv_days }}"
          if [ -n "$ARXIV_DAYS" ]; then
            CMD="$CMD --arxiv-days $ARXIV_DAYS"
          fi
          
          # ä¼šè®®
          if [ -n "${{ github.event.inputs.venues }}" ]; then
            VENUES=$(echo "${{ github.event.inputs.venues }}" | tr ',' ' ')
            CMD="$CMD --venue $VENUES"
          fi
          
          # å¹´ä»½
          if [ -n "${{ github.event.inputs.years }}" ]; then
            YEARS=$(echo "${{ github.event.inputs.years }}" | tr ',' ' ')
            CMD="$CMD --year $YEARS"
          fi
          
          # é™åˆ¶
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            CMD="$CMD --limit ${{ github.event.inputs.limit }}"
          fi
          
          echo "Running: $CMD"
          $CMD
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ•°æ®åº“å’Œè¾“å‡º
          git add data/ output/ -f
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            DATE=$(date +%Y-%m-%d)
            PAPER_COUNT=$(python -c "import sys; sys.path.insert(0,'src'); from database import get_repository; print(get_repository().get_paper_count())" 2>/dev/null || echo "N/A")
            
            git commit -m "chore: auto-update keywords [$DATE]" \
                       -m "ğŸ“Š Total papers: $PAPER_COUNT"
            
            git push
          fi
      
      - name: Notify deployed server (optional)
        if: ${{ vars.DEPLOY_URL != '' }}
        run: |
          # è°ƒç”¨éƒ¨ç½²æœåŠ¡å™¨çš„åˆ·æ–° API
          curl -X POST "${{ vars.DEPLOY_URL }}/api/refresh" \
            --connect-timeout 10 \
            --max-time 30 \
            -H "Content-Type: application/json" || true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ github.run_id }}
          path: |
            data/keywords.db
            output/reports/
            output/figures/
          retention-days: 30
