name: Update Keywords

on:
  schedule:
    # æ¯å‘¨æ—¥ UTC 0:00ï¼ˆåŒ—äº¬æ—¶é—´å‘¨æ—¥ 8:00ï¼‰
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      venues:
        description: 'è¦æ›´æ–°çš„ä¼šè®®ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ ICLR,NeurIPSï¼‰'
        required: false
        default: ''
      years:
        description: 'è¦æ›´æ–°çš„å¹´ä»½ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ 2024,2023ï¼‰'
        required: false
        default: ''
      limit:
        description: 'æ¯ä¸ªä¼šè®®å¹´ä»½çš„è®ºæ–‡é™åˆ¶ï¼ˆæµ‹è¯•ç”¨ï¼‰'
        required: false
        default: ''

jobs:
  update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run update pipeline
        env:
          OPENREVIEW_USERNAME: ${{ secrets.OPENREVIEW_USERNAME }}
          OPENREVIEW_PASSWORD: ${{ secrets.OPENREVIEW_PASSWORD }}
        run: |
          # æž„å»ºå‘½ä»¤å‚æ•°
          CMD="python -m src.main"
          
          if [ -n "${{ github.event.inputs.venues }}" ]; then
            VENUES=$(echo "${{ github.event.inputs.venues }}" | tr ',' ' ')
            CMD="$CMD --venue $VENUES"
          fi
          
          if [ -n "${{ github.event.inputs.years }}" ]; then
            YEARS=$(echo "${{ github.event.inputs.years }}" | tr ',' ' ')
            CMD="$CMD --year $YEARS"
          fi
          
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            CMD="$CMD --limit ${{ github.event.inputs.limit }}"
          fi
          
          echo "Running: $CMD"
          $CMD
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            DATE=$(date +%Y-%m-%d)
            PAPER_COUNT=$(python -c "from src.database import get_repository; print(get_repository().get_paper_count())" 2>/dev/null || echo "N/A")
            
            git commit -m "chore: auto-update keywords [$DATE]" \
                       -m "ðŸ“Š Total papers: $PAPER_COUNT"
            
            git push
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            output/reports/
            output/figures/
          retention-days: 30
