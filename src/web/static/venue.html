<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè®®åˆ†æ - DeepTrender</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-brand">
            <span class="brand-icon">ğŸ”¬</span>
            <span class="brand-text">DeepTrender</span>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">é¦–é¡µ</a>
            <a href="/venue.html" class="nav-link active">ä¼šè®®åˆ†æ</a>
            <a href="/trends.html" class="nav-link">è¶‹åŠ¿è¿½è¸ª</a>
            <a href="/comparison.html" class="nav-link">ä¼šè®®å¯¹æ¯”</a>
            <a href="/arxiv.html" class="nav-link">arXiv è¶‹åŠ¿</a>
        </div>
    </nav>

    <main class="container">
        <!-- ä¼šè®®é€‰æ‹©å™¨ -->
        <section class="venue-selector">
            <h1 id="venue-title">é€‰æ‹©ä¼šè®®</h1>
            <div class="venue-tabs" id="venue-tabs">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <!-- ä¼šè®®ç»Ÿè®¡ -->
        <section class="stats-grid" id="venue-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“„</div>
                <div class="stat-content">
                    <div class="stat-value" id="venue-paper-count">--</div>
                    <div class="stat-label">è®ºæ–‡æ€»æ•°</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-content">
                    <div class="stat-value" id="venue-year-count">--</div>
                    <div class="stat-label">è¦†ç›–å¹´ä»½</div>
                </div>
            </div>
        </section>

        <!-- è¯äº‘ -->
        <section class="chart-card full-width" id="venue-wordcloud-section" style="display: none;">
            <div class="chart-header">
                <h3>ğŸŒ¥ï¸ <span id="venue-cloud-title">ä¼šè®®</span> å…³é”®è¯äº‘</h3>
            </div>
            <div class="chart-body" id="chart-venue-wordcloud" style="height: 450px;"></div>
        </section>

        <!-- å¹´åº¦è¶‹åŠ¿ -->
        <section class="charts-grid" id="venue-charts-section" style="display: none;">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>ğŸ“ˆ å¹´åº¦è®ºæ–‡æ•°é‡</h3>
                </div>
                <div class="chart-body" id="chart-yearly-papers"></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3>ğŸ† çƒ­é—¨å…³é”®è¯å˜åŒ–</h3>
                </div>
                <div class="chart-body" id="chart-keyword-evolution"></div>
            </div>
        </section>

        <!-- å¹´åº¦è¯¦æƒ…è¡¨æ ¼ -->
        <section class="chart-card full-width" id="venue-table-section" style="display: none;">
            <div class="chart-header">
                <h3>ğŸ“Š å¹´åº¦ Top å…³é”®è¯</h3>
            </div>
            <div class="table-container">
                <table class="data-table" id="yearly-keywords-table">
                    <thead>
                        <tr id="table-header"></tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>DeepTrender - AI é¡¶ä¼šè®ºæ–‡å…³é”®è¯è¶‹åŠ¿åˆ†æç³»ç»Ÿ</p>
    </footer>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/charts.js"></script>
    <script>
        let currentVenue = null;

        async function init() {
            // ä» URL è·å–ä¼šè®®å‚æ•°
            const params = new URLSearchParams(window.location.search);
            const venueParam = params.get('venue');

            // åŠ è½½ä¼šè®®åˆ—è¡¨
            const overview = await API.getOverview();
            const tabs = document.getElementById('venue-tabs');

            tabs.innerHTML = overview.venues.map(v => `
                <button class="venue-tab ${v === venueParam ? 'active' : ''}" 
                        onclick="selectVenue('${v}')">${v}</button>
            `).join('');

            // å¦‚æœæœ‰å‚æ•°ï¼ŒåŠ è½½è¯¥ä¼šè®®
            if (venueParam) {
                selectVenue(venueParam);
            }
        }

        async function selectVenue(venue) {
            currentVenue = venue;

            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.venue-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent === venue);
            });

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('venue-title').textContent = venue;
            document.getElementById('venue-cloud-title').textContent = venue;

            // æ˜¾ç¤ºå†…å®¹åŒºåŸŸ
            document.getElementById('venue-stats').style.display = 'grid';
            document.getElementById('venue-wordcloud-section').style.display = 'block';
            document.getElementById('venue-charts-section').style.display = 'grid';
            document.getElementById('venue-table-section').style.display = 'block';

            // åŠ è½½æ•°æ®
            await loadVenueData(venue);
        }

        async function loadVenueData(venue) {
            try {
                const detail = await API.getVenueDetail(venue);

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('venue-paper-count').textContent =
                    detail.total_papers.toLocaleString();
                document.getElementById('venue-year-count').textContent =
                    detail.years.length;

                // è¯äº‘
                const wordcloudData = await API.getWordcloudData(venue, null, 100);
                Charts.renderWordcloud('chart-venue-wordcloud', wordcloudData);

                // å¹´åº¦è®ºæ–‡æ•°é‡æŸ±çŠ¶å›¾
                renderYearlyPapers(detail.yearly_stats);

                // å…³é”®è¯æ¼”å˜
                const trends = await API.getKeywordTrends([], venue);
                Charts.renderTrendChart('chart-keyword-evolution', trends);

                // è¡¨æ ¼
                renderYearlyTable(detail.yearly_stats);

            } catch (error) {
                console.error('åŠ è½½ä¼šè®®æ•°æ®å¤±è´¥:', error);
            }
        }

        function renderYearlyPapers(yearlyStats) {
            const chart = Charts.init('chart-yearly-papers');
            const sorted = [...yearlyStats].sort((a, b) => a.year - b.year);

            chart.setOption({
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: sorted.map(s => s.year),
                    axisLine: { lineStyle: { color: '#30363d' } },
                    axisLabel: { color: '#8b949e' }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { lineStyle: { color: '#30363d' } },
                    axisLabel: { color: '#8b949e' },
                    splitLine: { lineStyle: { color: '#21262d' } }
                },
                series: [{
                    type: 'bar',
                    data: sorted.map(s => s.paper_count),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ]),
                        borderRadius: [4, 4, 0, 0]
                    }
                }]
            });
        }

        function renderYearlyTable(yearlyStats) {
            const header = document.getElementById('table-header');
            const body = document.getElementById('table-body');

            const sorted = [...yearlyStats].sort((a, b) => b.year - a.year);
            const maxRank = 10;

            // è¡¨å¤´
            header.innerHTML = '<th>æ’å</th>' +
                sorted.map(s => `<th>${s.year}</th>`).join('');

            // è¡¨ä½“
            let rows = '';
            for (let i = 0; i < maxRank; i++) {
                rows += `<tr><td>${i + 1}</td>`;
                sorted.forEach(s => {
                    const kw = s.top_keywords[i];
                    rows += `<td>${kw ? kw.keyword : '-'}</td>`;
                });
                rows += '</tr>';
            }
            body.innerHTML = rows;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>

    <style>
        .venue-selector {
            margin-bottom: 2rem;
        }

        .venue-selector h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .venue-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .venue-tab {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .venue-tab:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .venue-tab.active {
            background: rgba(88, 166, 255, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .table-container {
            padding: 1rem;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            color: var(--text-secondary);
            font-weight: 600;
            background: var(--bg-tertiary);
        }

        .data-table td {
            color: var(--text-primary);
        }

        .data-table tr:hover td {
            background: rgba(88, 166, 255, 0.05);
        }
    </style>
</body>

</html>